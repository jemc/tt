#!/usr/bin/bash

REFRESH_TIME=0.2

FORMAT_DURATION="%H:%M:%S"
FORMAT_TIME="%H:%M:%S"
FORMAT_DATE="%a %b %d %Y"
FORMAT_ENTRY=$"  \${duration} | \${last_date} | \${last_time} - \${curr_time} \n"

ENTRIES=(\
  "  a test1 \n" \
  "  b test2 \n" \
  "  c test3 \n" \
)


file=$1
file_dir=$(dirname $file)

mkdir -p $file_dir
touch $file

# TODO: add warning about eval that shows the first time the program runs
# eval $file


function update_time {
  curr_date=$(date +"$FORMAT_DATE")
  curr_time=$(date +"$FORMAT_TIME")
  curr_secs=$(date +"%s")
}

function start_entry {
  update_time
  last_date=$curr_date
  last_time=$curr_time
  last_secs=$curr_secs
  update_curr_entry
}

function update_curr_entry {
  update_time
  duration=$(date -u -d @"$((curr_secs-last_secs))" +"$FORMAT_DURATION")
  eval "curr_entry=\"$FORMAT_ENTRY\""
}

function show_curr_entry {
  echo -ne "${curr_entry}"
}

function do_over {
  echo -ne "\033[1A"
}

function save_file {
  
  sh -c "cat > ${file}" <<MYEOF

REFRESH_TIME=${REFRESH_TIME}

FORMAT_DURATION="${FORMAT_DURATION}"
FORMAT_TIME="${FORMAT_TIME}"
FORMAT_DATE="${FORMAT_DATE}"
FORMAT_ENTRY="${FORMAT_ENTRY//\$/\\\$}"

ENTRIES=(\\
  "  a test1 \n" \\
  "  b test2 \n" \\
  "  c test3 \n" \\
)

MYEOF

}

function trap_func {
  echo
  echo 'saving...'
  
  save_file
  
  echo 'saved!'
  exit 0
}
trap trap_func SIGINT SIGTERM


for entry in "${ENTRIES[@]}"; do
  echo -ne "${entry}"
done

start_entry
show_curr_entry

while true; do
  update_curr_entry
  do_over
  show_curr_entry
  sleep $REFRESH_TIME
done
